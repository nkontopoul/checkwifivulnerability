import subprocess
import platform

def get_os_info():
    """
    Get the operating system information using an inline PowerShell command.
    
    Returns:
        dict: Dictionary containing OS information.
    """
    command = [
        "powershell",
        "-Command",
        "(Get-ComputerInfo -Property 'CsName', 'WindowsVersion', 'WindowsBuildLabEx', 'WindowsEditionId', 'WindowsInstallationType') | Format-List"
    ]
    try:
        # Run the PowerShell command and capture the output
        output = subprocess.check_output(command).decode("utf-8").strip()
        os_info = {}
        for line in output.splitlines():
            if ":" in line:
                key, value = line.split(":", 1)
                os_info[key.strip()] = value.strip()
        return os_info
    except subprocess.CalledProcessError as e:
        print(f"Error running PowerShell command: {e}")
        return {}

def check_kb_installed(kb_number):
    """
    Checks if a specific KB update is installed using wmic command.

    Args:
        kb_number (str): The KB number of the update to check (e.g., "KB5039212").

    Returns:
        bool: True if the update is found, False otherwise.
    """
    command = ["wmic", "qfe", "list", "full", f"/format:list"]
    try:
        # Run the wmic command and capture the output
        output = subprocess.check_output(command).decode("utf-8")
    except subprocess.CalledProcessError as e:
        print(f"Error running wmic command: {e}")
        return False

    # Check if the KB number is present in the output (ignoring case)
    return kb_number.upper() in output.upper()

if __name__ == "__main__":
    os_info = get_os_info()
    if os_info:
        print(f"Detected operating system: {os_info}")
        
        kb_number = "KB5039212"
        if check_kb_installed(kb_number):
            print(f"Update {kb_number} is installed. You are protected against CVE-2024-30078 Windows Wi-Fi Driver Remote Code Execution Vulnerability")
        else:
            print(f"Update {kb_number} is not found. You are NOT protected against CVE-2024-30078 Windows Wi-Fi Driver Remote Code Execution Vulnerability")
    else:
        print("Failed to retrieve OS information.")
